# binance-data-collection Service Requirements

## Service overview
The data-collection service ingests live candlestick (kline) data from Binance WebSocket streams, enriches it with warm-up history, and distributes normalized events to Kafka for downstream consumers. It also provides utilities for building historical backtest datasets on demand. Initialization is configuration-driven and metrics-rich for observability.

## Functional scope
- **WebSocket stream orchestration**: On startup the `KlineStreamManagerBinance` inspects the configured symbol/interval matrix and opens distinct WebSocket sessions for each stream, optionally auto-connecting during the `@PostConstruct` phase.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/domain/kline/KlineStreamManagerBinance.java†L27-L66】【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/config/BinanceDataCollectionConfig.java†L11-L41】
- **Warm-up history seeding**: Before a stream goes live the manager fetches a configurable number of historical klines through the REST client and publishes them via Kafka to guarantee the storage service receives a full processing window.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/domain/kline/KlineStreamManagerBinance.java†L82-L119】【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/rest/client/binance/BinanceRestKlineClient.java†L19-L64】
- **Streaming message handling**: Incoming WebSocket messages are decoded, mapped to the shared Avro `KlineEvent` schema, deduplicated based on timestamps, and published to Kafka with per-symbol/interval metrics updates.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/websocket/handler/BinanceTextMessageHandler.java†L21-L83】【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/domain/converter/BinanceWSDataToKlineEventConverter.java†L11-L30】
- **Kafka integration**: Events are published using the `KafkaProducerService`, which records send latency/failures and respects the topic defined under `binance.data.kline.kafkaTopic`. A lightweight consumer exists for debugging the outbound stream.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/kafka/producer/KafkaProducerService.java†L18-L60】【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/kafka/consumer/KafkaConsumerService.java†L13-L24】
- **Historical dataset sampling**: When `binance.sampler.enabled=true`, the `HistoricalSamplerRunner` coordinates range-based downloads that are cached locally and written to JSON datasets for backtesting via `BacktestDatasetFileWriter` and `HistoricalKlineCache`.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/sampler/HistoricalSamplerRunner.java†L12-L30】【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/sampler/HistoricalKlineSampler.java†L19-L126】
- **REST facade placeholder**: `DataCollectionRest` exists as the entry point for future management endpoints; currently it exposes no operations and should be populated when operational controls are defined.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/rest/DataCollectionRest.java†L5-L11】

## Configuration contract
- Binds to `binance.*` properties for REST credentials, WebSocket URL templates, and stream definitions, with sensible defaults for BTCUSDT/15m and warm-up sizes.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/config/BinanceDataCollectionConfig.java†L11-L41】
- Historical sampling uses the `binance.sampler.*` namespace to control symbol lists, intervals, date ranges, caching directories, and output locations.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/sampler/HistoricalSamplerProperties.java†L13-L39】
- Kafka bootstrap and schema registry URLs are read from Spring `spring.kafka.*` settings; note the current `KafkaConfig` bean is commented out pending cleanup and should be revisited before production hardening.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/config/KafkaConfig.java†L1-L56】

## Observability requirements
- Emit per-symbol counters/timers for WebSocket connections, REST fetches, Kafka sends, and kline processing durations via `DataCollectionMetrics`. Gauges expose active connections and last-seen timestamps for monitoring gaps.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/metrics/DataCollectionMetrics.java†L21-L209】
- Logging must remain at info/debug granularity for connection lifecycle, warm-up fetches, and event routing to simplify incident triage.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/domain/kline/KlineStreamManagerBinance.java†L67-L161】

## External dependencies
- Binance REST `/api/v3/klines` and WebSocket kline multiplexing endpoints for market data.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/rest/client/binance/BinanceRestKlineClient.java†L26-L64】【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/domain/kline/KlineStreamManagerBinance.java†L101-L140】
- Kafka cluster with Confluent Schema Registry for publishing `KlineEvent` Avro records.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/kafka/producer/KafkaProducerService.java†L18-L58】
- Shared model module for Avro schemas (`binance-shared-model`).【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/domain/converter/BinanceWSDataToKlineEventConverter.java†L11-L30】

## Known gaps & TODOs
- Kafka configuration beans are temporarily disabled (`@Configuration` commented); enable and verify before deploying outside local environments.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/config/KafkaConfig.java†L18-L22】
- REST controller lacks operational endpoints for stream management or sampler triggering; scope and expose once requirements are defined.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/rest/DataCollectionRest.java†L5-L11】
- Error handling for WebSocket reconnection currently logs failures but does not retry; future reliability work should incorporate exponential backoff and alerting hooks.【F:binance-data-collection/src/main/java/com/oyakov/binance_data_collection/domain/kline/KlineStreamManagerBinance.java†L134-L160】
