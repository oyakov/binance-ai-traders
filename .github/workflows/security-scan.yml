name: Scheduled Security Scan

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  
  workflow_dispatch:

jobs:
  scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'
      
      - name: OWASP Dependency Check
        run: |
          mvn org.owasp:dependency-check-maven:check
          echo "✓ Dependency check completed"
        continue-on-error: true
      
      - name: Build Docker images
        run: |
          mvn clean package -DskipTests
          docker compose -f docker-compose-testnet.yml build
      
      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
      
      - name: Scan all Docker images
        run: |
          for service in binance-trader-macd binance-data-collection binance-data-storage; do
            echo "Scanning $service..."
            trivy image --severity HIGH,CRITICAL \
              --format json \
              --output ${service}-scan.json \
              binance-ai-traders-${service}-testnet || true
          done
      
      - name: Check for secrets in repository
        run: |
          docker run --rm -v $(pwd):/scan \
            trufflesecurity/trufflehog:latest \
            filesystem /scan \
            --json > secrets-scan.json || true
          
          if [ -s secrets-scan.json ]; then
            echo "⚠️  Potential secrets found!"
            exit 1
          fi
      
      - name: Generate security report
        if: always()
        run: |
          echo "## 🔒 Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scans Performed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Maven dependency check" >> $GITHUB_STEP_SUMMARY
          echo "- Docker image vulnerability scan (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo "- Secret detection in repository" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY
      
      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            target/dependency-check-report.html
            *-scan.json
            secrets-scan.json
          retention-days: 90

